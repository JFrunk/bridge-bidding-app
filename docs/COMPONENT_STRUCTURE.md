# Component Structure & Architecture

## Visual Directory Structure

```
frontend/src/
├── 📁 components/
│   ├── 📁 ui/                          # 🎨 SHADCN BASE COMPONENTS (Don't modify)
│   │   ├── button.jsx                  #    Generated by Shadcn CLI
│   │   ├── card.jsx                    #    Standard UI primitives
│   │   ├── dialog.jsx                  #    Accessible, unstyled base
│   │   ├── select.jsx                  #    Built on Radix UI
│   │   ├── textarea.jsx                #    Keyboard-friendly
│   │   └── ...                         #    Add more as needed
│   │
│   ├── 📁 bridge/                      # 🃏 BRIDGE-SPECIFIC COMPONENTS
│   │   ├── bridge-card.jsx             #    Playing card (A♠, K♥, etc.)
│   │   ├── bidding-box.jsx             #    Bidding interface (1♣, Pass, X)
│   │   ├── bidding-table.jsx           #    Auction history table
│   │   ├── hand-analysis.jsx           #    HCP, distribution display
│   │   ├── review-modal.jsx            #    AI review request dialog
│   │   ├── convention-help-modal.jsx   #    Convention info display
│   │   └── __tests__/                  #    Tests for each component
│   │
│   └── 📁 play/                        # 🎮 PLAY PHASE COMPONENTS
│       ├── play-table.jsx              #    Main play area (compass layout)
│       ├── contract-header.jsx         #    Contract, tricks, bidding summary
│       ├── trick-display.jsx           #    Current trick in center
│       ├── user-hand.jsx               #    South (user) hand
│       ├── dummy-hand.jsx              #    Revealed dummy hand
│       ├── turn-indicator.jsx          #    Whose turn indicator
│       ├── contract-goal-tracker.jsx   #    Tricks won/needed progress
│       ├── score-modal.jsx             #    End-of-hand scoring
│       └── __tests__/                  #    Tests for each component
│
├── 📁 stores/                          # 🗄️ ZUSTAND STATE STORES
│   ├── biddingStore.js                 #    Bidding phase state
│   ├── playStore.js                    #    Play phase state
│   └── uiStore.js                      #    UI state (modals, errors)
│
├── 📁 lib/                             # 🛠️ UTILITIES
│   └── utils.js                        #    cn() helper, formatters
│
├── 📁 shared/                          # ⚠️ LEGACY (To be migrated)
│   ├── components/
│   │   ├── Card.js                     #    OLD: Migrate to bridge/bridge-card.jsx
│   │   ├── HandAnalysis.js             #    OLD: Migrate to bridge/hand-analysis.jsx
│   │   └── PlayerHand.js               #    OLD: Migrate to play/user-hand.jsx
│   └── services/
│       └── SessionService.js           #    Keep (not UI-related)
│
├── App.js                              # 🏠 MAIN APP COMPONENT
├── App.css                             # ⚠️ TO BE REMOVED (migrate to Tailwind)
├── index.js                            # Entry point
├── index.css                           # Global styles + Tailwind imports
├── PlayComponents.js                   # ⚠️ TO BE REMOVED (migrate to play/ folder)
└── PlayComponents.css                  # ⚠️ TO BE REMOVED (migrate to Tailwind)
```

---

## Component Dependency Graph

```
┌─────────────────────────────────────────────────────────────┐
│                          App.js                             │
│  Main application component                                 │
│  Orchestrates bidding and play phases                       │
└───────────────────┬────────────┬─────────────┬──────────────┘
                    │            │             │
        ┌───────────▼────┐  ┌────▼──────┐  ┌──▼──────────┐
        │ Bidding Phase  │  │ Play Phase│  │ Common UI   │
        └───────┬────────┘  └─────┬─────┘  └──────┬──────┘
                │                 │                │
    ┌───────────┼─────────┐       │       ┌────────┼────────┐
    │           │         │       │       │        │        │
┌───▼───┐  ┌───▼───┐  ┌──▼──┐ ┌──▼──┐ ┌──▼───┐ ┌─▼──┐  ┌──▼───┐
│Bidding│  │Bidding│  │Hand │ │Play │ │User  │ │Dummy│ │Review│
│ Box   │  │ Table │  │Analy│ │Table│ │ Hand │ │Hand │ │Modal │
└───┬───┘  └───────┘  └──┬──┘ └──┬──┘ └──┬───┘ └──┬──┘ └──────┘
    │                     │       │       │        │
    │                     │       │       │        │
┌───▼─────────────────────▼───────▼───────▼────────▼──────────┐
│             🃏 BridgeCard Component                          │
│  Base component used everywhere cards are displayed         │
│  (bidding hand, play hand, dummy, trick display)            │
└──────────────────────────────────────────────────────────────┘
                            │
                            │
                ┌───────────▼───────────┐
                │  Shadcn Card (base)   │
                │  + Tailwind CSS       │
                └───────────────────────┘
```

---

## State Management Flow

```
┌─────────────────────────────────────────────────────────────┐
│                     React Component Tree                    │
└──────────────────────┬──────────────────────────────────────┘
                       │
       ┌───────────────┼───────────────┐
       │               │               │
┌──────▼──────┐  ┌────▼─────┐  ┌─────▼──────┐
│ Bidding     │  │   Play   │  │     UI     │
│ Components  │  │Components│  │ Components │
└──────┬──────┘  └────┬─────┘  └─────┬──────┘
       │              │              │
       │ useStore()   │ useStore()   │ useStore()
       │              │              │
┌──────▼──────┐  ┌────▼─────┐  ┌─────▼──────┐
│ Bidding     │  │   Play   │  │     UI     │
│   Store     │  │  Store   │  │   Store    │
│ (Zustand)   │  │(Zustand) │  │ (Zustand)  │
└──────┬──────┘  └────┬─────┘  └─────┬──────┘
       │              │              │
       │              │              │
┌──────▼──────────────▼──────────────▼──────┐
│       Derived State & Selectors           │
│  Computed values, memoized calculations   │
└───────────────────────────────────────────┘
```

### Bidding Store State
```javascript
{
  hand: [],                  // User's cards
  handPoints: {...},         // HCP, distribution
  auction: [],               // Bid history
  nextPlayerIndex: 0,        // Whose turn
  isAiBidding: false,        // AI turn in progress
  vulnerability: 'None',     // Vuln status
  allHands: null,            // All 4 hands (debug)
  showHandsThisDeal: false,  // Show all hands
  alwaysShowHands: false,    // Always show mode
  selectedScenario: '',      // Scenario name
  scenarioList: [],          // Available scenarios
  initialDeal: null,         // Starting state (for replay)
}
```

### Play Store State
```javascript
{
  gamePhase: 'bidding',      // 'bidding' | 'playing'
  playState: {...},          // Current play state from backend
  dummyHand: [],             // Dummy's cards
  declarerHand: [],          // Declarer's cards (if user is dummy)
  isPlayingCard: false,      // Card play in progress
  scoreData: null,           // Final score (end of hand)
}
```

### UI Store State
```javascript
{
  error: '',                 // Error message to display
  displayedMessage: '',      // Feedback message
  showReviewModal: false,    // AI review modal state
  showConventionHelp: false, // Convention help modal
  conventionInfo: null,      // Convention data
  reviewPrompt: '',          // Generated review prompt
}
```

---

## Component Relationships

### BridgeCard
**Used by**: BiddingBox, UserHand, DummyHand, TrickDisplay, HandAnalysis

**Props**:
```jsx
<BridgeCard
  rank="A"                 // 'A', 'K', 'Q', 'J', 'T', '9', etc.
  suit="♠"                 // '♠', '♥', '♦', '♣'
  onClick={handleClick}    // Optional click handler
  disabled={false}         // Disable interaction
  className=""             // Additional Tailwind classes
/>
```

### BiddingBox
**Used by**: App.js (during bidding phase)

**Props**:
```jsx
<BiddingBox
  onBid={handleUserBid}    // Callback: (bid: string) => void
  disabled={!userTurn}     // Disable all buttons
  auction={[...]}          // Bid history for legal bid validation
/>
```

### PlayTable
**Used by**: App.js (during play phase)

**Props**:
```jsx
<PlayTable
  playState={state}              // Current play state
  userHand={[...]}               // South's cards
  dummyHand={[...]}              // Dummy's cards
  declarerHand={[...]}           // Declarer's cards (if user is dummy)
  onCardPlay={handleCardPlay}    // User card click
  onDummyCardPlay={handleDummy}  // Dummy card click (user controls)
  onDeclarerCardPlay={handleDec} // Declarer card click (user is dummy)
  isUserTurn={true}              // Is it user's turn?
  isDummyTurn={false}            // Is it dummy's turn (user controls)?
  isDeclarerTurn={false}         // Is it declarer's turn (user is dummy)?
  auction={[...]}                // Bid history
/>
```

---

## Styling Patterns

### Pattern 1: Card Component (Shadcn Base + Tailwind)
```jsx
import { Card } from "@/components/ui/card";
import { cn } from "@/lib/utils";

export function BridgeCard({ rank, suit, className }) {
  return (
    <Card className={cn(
      "w-[70px] h-[100px]",    // Size
      "bg-white",               // Background
      "border border-gray-400", // Border
      "rounded-card",           // Border radius (custom: 6px)
      "shadow-md",              // Shadow
      className                 // Allow overrides
    )}>
      {/* Content */}
    </Card>
  );
}
```

### Pattern 2: Layout with Responsive Spacing
```jsx
<div className={cn(
  "flex flex-col",      // Vertical stack
  "gap-4 md:gap-6",     // Mobile: 1rem, Desktop: 1.5rem
  "p-4 md:p-6",         // Mobile: 1rem padding, Desktop: 1.5rem
  "bg-bg-secondary",    // Custom background color
  "rounded-lg"          // Large border radius (12px)
)}>
  {/* Content */}
</div>
```

### Pattern 3: Conditional Styling
```jsx
<Button className={cn(
  "base-classes",                          // Always applied
  isActive && "bg-success text-white",     // Active state
  isDisabled && "opacity-60 cursor-not-allowed", // Disabled
  variant === 'primary' && "font-bold",    // Variant
)}>
  {label}
</Button>
```

### Pattern 4: Suit Colors
```jsx
const getSuitColor = (suit) => {
  return (suit === '♥' || suit === '♦') ? 'text-suit-red' : 'text-suit-black';
};

<span className={cn("text-2xl", getSuitColor(suit))}>
  {suit}
</span>
```

---

## Migration Checklist by Component

### ✅ Ready to Migrate (Clear Path)
- [x] Card → BridgeCard (in REFACTORING_PLAN)
- [x] BiddingBox (in REFACTORING_PLAN)
- [x] ReviewModal (in REFACTORING_PLAN)
- [x] ConventionHelpModal (in REFACTORING_PLAN)

### 🟡 Medium Complexity (Needs Breakdown)
- [ ] BiddingTable → Use Shadcn Table component
- [ ] HandAnalysis → Simple info display, straightforward
- [ ] ScoreDisplay → Shadcn Dialog with table

### 🔴 High Complexity (Careful Planning)
- [ ] PlayTable → Break into subcomponents first
  - [ ] ContractHeader (done in REFACTORING_PLAN)
  - [ ] TrickDisplay (compass layout)
  - [ ] PlayerPositions (N/E/S/W arrangement)
- [ ] AI Play Loop → State management, careful testing
- [ ] Card Play Logic → Must preserve exact behavior

---

## Testing Strategy

### Unit Tests (Component Level)
```javascript
// Example: BridgeCard.test.jsx
describe('BridgeCard', () => {
  it('renders rank and suit');
  it('applies correct suit color');
  it('handles click when not disabled');
  it('does not handle click when disabled');
  it('has correct aria-label');
  it('applies custom className');
});
```

### Integration Tests (Feature Level)
```javascript
// Example: bidding-flow.test.jsx
describe('Bidding Flow', () => {
  it('allows user to bid on their turn');
  it('prevents user from bidding on AI turn');
  it('validates legal bids only');
  it('transitions to play after auction ends');
});
```

### E2E Tests (Full Game)
```javascript
// Example: full-game.test.jsx
describe('Full Game Flow', () => {
  it('completes bidding phase');
  it('starts play phase with correct contract');
  it('allows card play for declarer and dummy');
  it('calculates score correctly at end');
});
```

---

## Performance Considerations

### Lazy Loading
```jsx
import { lazy, Suspense } from 'react';

const PlayTable = lazy(() => import('@/components/play/play-table'));

// In component:
<Suspense fallback={<div>Loading...</div>}>
  <PlayTable {...props} />
</Suspense>
```

### Memoization
```jsx
import { memo, useMemo } from 'react';

export const BridgeCard = memo(({ rank, suit, onClick }) => {
  const suitColor = useMemo(() =>
    getSuitColor(suit),
    [suit]
  );

  return (/* ... */);
});
```

### Virtual Scrolling (if needed for long lists)
```jsx
// For auction history with 100+ bids
import { useVirtualizer } from '@tanstack/react-virtual';
```

---

## Accessibility Standards

### Keyboard Navigation
- All interactive elements must be keyboard accessible
- Focus visible: `focus:ring-2 focus:ring-info`
- Tab order logical (top to bottom, left to right)

### Screen Reader Support
- aria-label on all buttons: `aria-label="Bid 1 Spade"`
- aria-live regions for dynamic updates: `aria-live="polite"`
- Role attributes: `role="button"`, `role="region"`

### Color Contrast
- Must meet WCAG AA (4.5:1 for normal text, 3:1 for large text)
- Test with axe DevTools
- Don't rely on color alone (use icons/text too)

---

## Deployment Checklist

### Before Merge
- [ ] All tests pass (`npm test`)
- [ ] Build succeeds (`npm run build`)
- [ ] Bundle size check (`npx source-map-explorer`)
- [ ] Lighthouse audit (>90 all categories)
- [ ] Manual testing (bidding + play flow)
- [ ] Mobile responsive check (320px, 768px, 1024px)
- [ ] Accessibility audit (axe DevTools, keyboard nav)
- [ ] Code review (follow Rule of Three?)

### After Merge
- [ ] Monitor production for errors
- [ ] Check performance metrics
- [ ] User feedback
- [ ] Rollback plan ready

---

**Last Updated**: 2025-10-13
**Version**: 1.0
**Related Documents**:
- [UI_UX_FRAMEWORK.md](./UI_UX_FRAMEWORK.md) - Strategic framework
- [REFACTORING_PLAN.md](./REFACTORING_PLAN.md) - Implementation steps
- [LLM_PROMPTING_GUIDE.md](./LLM_PROMPTING_GUIDE.md) - Prompt templates
